name: Validate infrastructure

on:
  workflow_dispatch:
  pull_request:
    branches: [main]

env:
  INFRASTRUCTURE_TEMPLATE_LOCATION: ./infrastructure/main.bicep
  INFRASTRUCTURE_PARAMETER_LOCATION: ./infrastructure/parameters/common.json
  WEB_APP_LOCATION: project/web
  WEB_APP_ARTIFACT_LOCATION: dist # relative to WEB_APP_LOCATION

jobs:
 validate-infrastructure:
    environment: dev

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: azure/login@v1
        with: 
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate infrastructure
        uses: ./.github/actions/infrastructure
        with:
          deploy: false
          environment: dev
          web_app_location: ${{ env.WEB_APP_LOCATION }}
          web_app_artifact_location: ${{ env.WEB_APP_ARTIFACT_LOCATION }}
          infrastructure_template_location: ${{ env.INFRASTRUCTURE_TEMPLATE_LOCATION }}
          infrastructure_parameter_location: ${{ env.INFRASTRUCTURE_PARAMETER_LOCATION }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          resource_group: ${{ secrets.AZURE_RG }}
          subscription_id: ${{ secrets.AZURE_SUBSCRIPTION }}
